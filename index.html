<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORPSE CHASM</title>
    <link rel="icon" type="image/png" href="/imgs/favicon.png" />
    <script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            padding: 20px;
        }

        #my_text,
        #my_options {
            white-space: pre-wrap;
        }

        button {
            background-color: black;
            color: white;
            font-family: 'Courier New', 'Courier New', Courier, monospace;
            border: 0px;
            padding: 5px 5px;
            cursor: pointer;
            margin-top: 10px;
            text-decoration: underline;
            text-align: left;
            display: block;
        }

        button:hover {
            background-color: red;
        }

        .ascii-art {
            color: rgb(130, 0, 0);
            font-family: 'Courier New', Courier, monospace;
            white-space: pre;
        }

        #skip-instruction {
            position: absolute;
            bottom: 10px;
            right: 20px;
            color: gray;
            font-size: 0.8em;
        }
    </style>
</head>

<body>

    <div id="my_text">
        <h1>Loading...</h1>
    </div>

    <img id="my_img" src="" />

    <div id="my_options"></div>

    <div id="player_stats"
        style="position: absolute; top: 20px; right: 20px; background-color: rgba(0, 0, 0, 0.7); padding: 10px; border: 1px solid white; color: white; font-family: 'Courier New', Courier, monospace;">
        <div id="stats_content"></div>
    </div>

    <div id="skip-instruction">Press Enter to skip</div>

    <script>
        var current_state = 'start';
        var our_game_data = null;
        var bk_audio = new Audio();
        let typingInterval;

        //Player stats are static and not read from game_def
        const player = {
            name: "Kargunt",
            health: 15,
            maxHealth: 15,
            silver: 15 + rollD6(),
            weapon: { name: "Beinrýtingur", attack: 4 },
            armor: null,
            xp: 0,
            points: 0,
            items: [],
            scrolls: []
        };

        let currentEnemy = {};

        //Update player stats
        function updateStats() {
            const statsContent = `
            <strong>Name:</strong> ${player.name}<br>
            <strong>HP:</strong> ${player.health}/15<br>
            <strong>Silver:</strong> ${player.silver}<br>
            <strong>Weapon:</strong> ${player.weapon.name} (Attack: ${player.weapon.attack})<br>
            <strong>Armor:</strong> ${player.armor ? player.armor : 'None'}<br>
            <strong>XP:</strong> ${player.xp}<br>
            <strong>Points:</strong> ${player.points}<br>
            <strong>Items:</strong> ${player.items.length}/3<br>
            <strong>Scrolls:</strong> ${player.scrolls.length}/3`;
            $('#stats_content').html(statsContent);
        }

        //Top-down rendering effect for ASCII art
        function scanText(element, text, speed) {
            console.log("Rendering Scan Effect");
            let lines = text.split("\n");
            let i = 0;

            function scan() {
                if (i < lines.length) {
                    element.append(lines[i] + "<br>");
                    i++;
                    setTimeout(scan, speed);
                }
            }

            scan();
        }

        //Typewriter rendering effect for all text
        function typeText(element, text, speed, callback = null) {
            element.html('');
            $('#skip-instruction').show();
            let i = 0;
            let typing = true;

            //Skip typewriter effect if player presses enter
            const handleKeyDown = (event) => {
                if (event.key === 'Enter' && typing) {
                    console.log("Skipping Text!");
                    clearTimeout(typingInterval);
                    element.html(text);
                    typing = false;
                    $('#skip-instruction').hide();
                    document.removeEventListener('keydown', handleKeyDown);
                    callback && callback();
                }
            };

            document.addEventListener('keydown', handleKeyDown);

            const type = () => {
                if (i < text.length) {
                    element.append(text[i++]);
                    typingInterval = setTimeout(type, speed);
                } else {
                    typing = false;
                    $('#skip-instruction').hide();
                    document.removeEventListener('keydown', handleKeyDown);
                    callback && callback();
                }
            };
            type();
        }

        //Called to ensure text clears between state transitions
        function clearText() {
            $('#my_text').html('');
            clearTimeout(typingInterval);
            typingInterval = null;
        }

        //Renders button options defined in state
        function renderOptions(options) {
            if (options) {
                let build_html = '';
                options.forEach(function (option) {
                    build_html += "<button onclick='current_state = \"" + option['next_state'] + "\"; visit_state();'>";
                    build_html += option['text'] + "</button><br>\n";
                });
                $('#my_options').html(build_html);
            }
        }

        function rollD4() {
            console.log("Rolling d4...");
            return Math.floor(Math.random() * 4) + 1; // Rolls a d4
        }

        function rollD6() {
            console.log("Rolling d6...");
            return Math.floor(Math.random() * 6) + 1; // Rolls a d6
        }

        function selectEnemy() {
            const enemies = our_game_data.pools.enemies;
            const randomIndex = Math.floor(Math.random() * enemies.length);
            currentEnemy = enemies[randomIndex];

            console.log("Facing Enemy:", currentEnemy.name);

            const enemyDesc = currentEnemy.description;
            const enemyName = currentEnemy.name;

            const fullDescription = `${enemyName} approaches.\n\nIt is ${enemyDesc}`;
            typeText($('#my_text'), fullDescription, 50);

        }

        function enterCombat() {
            //Select random enemy from pool and display its intro
            selectEnemy();

            //Now player selects Attack or Flee
        }

        function generateRoom() {
            console.log("Generating Room...");
            const roomsPool = our_game_data.pools.rooms;
            const eventsPool = our_game_data.pools.events;

            const randomRoom = roomsPool[Math.floor(Math.random() * roomsPool.length)];
            const randomEvent = eventsPool[Math.floor(Math.random() * eventsPool.length)];

            const roomDescription = randomRoom.description;
            const eventDescription = randomEvent.description;

            console.log("\nRoom is: ", randomRoom.name);
            console.log("\nEvent name: ", randomEvent.name);

            $('#my_options').html('');

            // Set current state to HandleEvent after generating the room and event
            current_state = 'HandleEvent';
            console.log("Current state is: ", current_state);

            our_game_data['HandleEvent']['text'] = eventDescription;
            // Save the event type for the next state transition after the player clicks "Proceed"
            our_game_data['HandleEvent']['next_state'] = randomEvent.type;

            // Update the text to display the room and event
            const fullDescription = `You enter ${roomDescription}\n\n${eventDescription}`;
            typeText($('#my_text'), fullDescription, 50);  // Let the text type out progressively

            renderOptions([{
                text: "Proceed",
                next_state: our_game_data['HandleEvent']['next_state'] // Transition based on the event type
            }]);
        }

        function visit_state(state) {
            let textElement = $('#my_text');
            clearText();

            // Log the current state and game data
            console.log("Visiting State:", current_state);
            console.log("Game Data:", our_game_data);

            if (our_game_data[current_state]['back_sound'] != null) {
                console.log("Changing music!");
                bk_audio.pause();
                if (our_game_data[current_state]['back_sound'] == '') {
                    bk_audio.pause();
                }
                bk_audio = new Audio(our_game_data[current_state]['back_sound']);
                bk_audio.play();

                bk_audio.addEventListener('timeupdate', function () {
                    var buffer = .44
                    if (this.currentTime > this.duration - buffer) {
                        this.currentTime = 0
                        this.play()
                    }
                });
            }

            // Check if the current state exists in the game data
            if (!our_game_data[current_state]) {
                console.error("State does not exist in game data:", current_state);
                return; // Exit early to prevent further errors
            }

            if (current_state === 'GetWeap') {
                player.weapon = { name: 'Beinrýtingur', attack: 'D4 + 1' };
                updateStats();
            }

            if (current_state === 'GenerateRoom') {
                generateRoom();
                let options = our_game_data[current_state]['next_state'];
                renderOptions(options);
                return; // Exit early as we've already handled the room generation
            }

            if (current_state === 'combat') {
                console.log("About to handle combat!");
                let options = our_game_data[current_state]['next_state'];
                enterCombat();
                renderOptions(options);
                return; // Ensure we don't execute the rest of the function in combat state
            }

            if (current_state === 'FleeAttempt'){
                console.log("Attempting to flee combat!");

                if (rollD6() <= 3){
                    let options = our_game_data[current_state]['fail_state']; 

                } else {
                    let options = our_game_data[current_state]['success_state'];     
                }
                renderOptions(options);
            }

            // Check if there is text to display
            if (our_game_data[current_state]['text'] != null) {
                let stateText = our_game_data[current_state]['text'];
                if (stateText) {
                    stateText = stateText.replace(/<[^>]*>/g, '');
                    let typingSpeed = 50;
                    typeText(textElement, stateText, typingSpeed, function () {
                        showAsciiArt();
                    });
                } else {
                    textElement.hide();
                }
            } else {
                console.warn("No text found for current state:", current_state);
            }

            if (our_game_data[current_state]['img'] != null) {
                $("#my_img").attr("src", our_game_data[current_state]['img']);
                $('#my_img').show();
            } else {
                $('#my_img').hide();
            }

            let options = our_game_data[current_state]['next_state'];
            renderOptions(options);
        }

        $(document).ready(function () {
            setTimeout(function () {
                $.getJSON("game_def.json", function (data) {
                    our_game_data = data;
                    visit_state(current_state);
                });
            }, 1000);
        });

        //Reads ASCII art from game data and displays it with scanText render effect
        function showAsciiArt() {
            if (our_game_data[current_state]['ascii-art'] != null) {
                let asciiElement = $('<div class="ascii-art"></div>');
                $('#my_text').append(asciiElement);
                let asciiArt = our_game_data[current_state]['ascii-art'];
                let scanningSpeed = 200;
                scanText(asciiElement, asciiArt, scanningSpeed);
            }
        }
    </script>

</body>

</html>